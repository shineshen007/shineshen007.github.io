---
layout: post
title: jupyteré…ç½®ä¸ä½¿ç”¨
tags: [Linux]
categories: [conda]
---
------------------------------------------------------------------------




# jupyter ç»å¸¸åœ¨é‡å¯å·¥ä½œç«™ä¹‹åæ— æ³•æ‰“å¼€
1: è¿›å…¥root
2: è¿›å…¥condaç¯å¢ƒâ€˜
3: æŸ¥æ‰¾ç«¯å£å·

# ğŸ§© JupyterHub Conda å®‰è£…ä¸å¤šç”¨æˆ·é…ç½®å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ **Conda å®‰è£… JupyterHub**ï¼Œå¹¶é…ç½®æˆæ”¯æŒ **å¤šç”¨æˆ·ç™»å½•ä¸ç‹¬ç«‹ Conda ç¯å¢ƒ** çš„ç§‘ç ”/æ•™å­¦æœåŠ¡å™¨ã€‚

---

## ğŸ“˜ ä¸€ã€åˆ›å»º Conda ç¯å¢ƒ

```bash
# ç¡®è®¤ Conda å¯ç”¨
which conda

# åˆ›å»º jupyterhub ç‹¬ç«‹ç¯å¢ƒ
conda create -n jhub_env python=3.10 -y

# æ¿€æ´»ç¯å¢ƒ
conda activate jhub_env
```

---

## ğŸ“¦ äºŒã€å®‰è£… JupyterHub åŠä¾èµ–

```bash
# å®‰è£…æ ¸å¿ƒç»„ä»¶
conda install -c conda-forge jupyterhub -y

# å®‰è£… Notebook ä¸ Lab æ”¯æŒ
conda install -c conda-forge notebook jupyterlab -y

# å®‰è£…ä»£ç†æœåŠ¡ï¼ˆå¿…éœ€ï¼‰
conda install -c conda-forge configurable-http-proxy -y
```

éªŒè¯è·¯å¾„ï¼š

```bash
which jupyterhub
# ç¤ºä¾‹è¾“å‡ºï¼š/opt/conda/envs/jhub_env/bin/jupyterhub
```

---

## âš™ï¸ ä¸‰ã€ç”Ÿæˆé…ç½®æ–‡ä»¶

```bash
sudo mkdir -p /etc/jupyterhub
sudo /opt/conda/envs/jhub_env/bin/jupyterhub --generate-config -f /etc/jupyterhub/jupyterhub_config.py
```

---

## ğŸ§© å››ã€ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šç”¨æˆ· + Conda ç¯å¢ƒï¼‰

å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸ºï¼š
`/etc/jupyterhub/jupyterhub_config.py`

```python
###############################################################################
# ğŸ“˜ åŸºæœ¬ä¿¡æ¯
###############################################################################
c.JupyterHub.bind_url = 'http://:8000'

# Hub è¿è¡Œçš„æ•°æ®åº“å’Œå¯†é’¥å­˜å‚¨
c.JupyterHub.cookie_secret_file = '/etc/jupyterhub/jupyterhub_cookie_secret'
c.JupyterHub.db_url = 'sqlite:////etc/jupyterhub/jupyterhub.sqlite'

###############################################################################
# ğŸ‘¥ ç”¨æˆ·è®¤è¯é…ç½®
###############################################################################
from jupyterhub.auth import PAMAuthenticator
c.JupyterHub.authenticator_class = PAMAuthenticator
c.PAMAuthenticator.open_sessions = False

# ç®¡ç†å‘˜ä¸ç™½åå•
c.Authenticator.admin_users = {'root'}
# c.Authenticator.allowed_users = {'alice', 'bob', 'charlie'}

###############################################################################
# ğŸ§  Notebook / Lab é»˜è®¤è¡Œä¸º
###############################################################################
c.Spawner.default_url = '/lab'
c.Spawner.cmd = ['jupyter-labhub']

###############################################################################
# ğŸ§° è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ç›®å½•
###############################################################################
import os
from jupyterhub.spawner import LocalProcessSpawner

class AutoHomeSpawner(LocalProcessSpawner):
    def start(self):
        user_home = os.path.expanduser(f'~{self.user.name}')
        nb_dir = os.path.join(user_home, 'notebooks')
        if not os.path.exists(nb_dir):
            os.makedirs(nb_dir, exist_ok=True)
        self.notebook_dir = nb_dir
        return super().start()

c.JupyterHub.spawner_class = AutoHomeSpawner

###############################################################################
# ğŸ§ª Conda ç¯å¢ƒæ”¯æŒ
###############################################################################
import shutil

def detect_user_conda_env(spawner):
    user_env_path = f"/opt/conda/envs/{spawner.user.name}/bin/jupyter-labhub"
    default_env_path = "/opt/conda/envs/jhub_env/bin/jupyter-labhub"
    if os.path.exists(user_env_path):
        return [user_env_path]
    elif shutil.which("jupyter-labhub"):
        return ["jupyter-labhub"]
    else:
        return [default_env_path]

c.Spawner.cmd = detect_user_conda_env

###############################################################################
# ğŸ“œ æ—¥å¿—ä¸è°ƒè¯•
###############################################################################
c.JupyterHub.extra_log_file = '/var/log/jupyterhub.log'
c.JupyterHub.log_level = 'INFO'

###############################################################################
# ğŸ”’ Proxy ä¸å®‰å…¨
###############################################################################
c.JupyterHub.proxy_cmd = ['/opt/conda/envs/jhub_env/bin/configurable-http-proxy']
# è‹¥å¯ç”¨ HTTPSï¼š
# c.JupyterHub.ssl_cert = '/etc/ssl/certs/jhub.crt'
# c.JupyterHub.ssl_key = '/etc/ssl/private/jhub.key'

###############################################################################
# âš™ï¸ å…¶ä»–å¯é€‰é¡¹
###############################################################################
c.JupyterHub.allow_named_servers = True
c.JupyterHub.cleanup_servers = False
###############################################################################
```

---

## ğŸ§¾ äº”ã€åˆ›å»º systemd æœåŠ¡

`/etc/systemd/system/jupyterhub.service`ï¼š

```ini
[Unit]
Description=JupyterHub (with conda multi-env support)
After=network.target

[Service]
Type=simple
ExecStart=/opt/conda/envs/jhub_env/bin/jupyterhub -f /etc/jupyterhub/jupyterhub_config.py
WorkingDirectory=/root
Environment="PATH=/opt/conda/envs/jhub_env/bin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Restart=always
User=root

[Install]
WantedBy=multi-user.target
```

åŠ è½½å¹¶å¯åŠ¨ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable jupyterhub
sudo systemctl restart jupyterhub
sudo systemctl status jupyterhub
```

---

## âš™ï¸ å…­ã€ç”¨æˆ·ç¯å¢ƒç®¡ç†

### âœ… åˆ›å»ºç³»ç»Ÿç”¨æˆ·
```bash
sudo useradd -m alice
sudo passwd alice
```

### âœ… åˆ›å»ºå¯¹åº” Conda ç¯å¢ƒ
```bash
conda create -n alice python=3.10 -y
conda activate alice
conda install -c conda-forge jupyterlab ipykernel -y

# æ³¨å†Œ kernel
python -m ipykernel install --user --name alice --display-name "Python (alice)"
```

---

## âœ… ä¸ƒã€è®¿é—®ä¸éªŒè¯

æµè§ˆå™¨è®¿é—®ï¼š  
```
http://<æœåŠ¡å™¨IP>:8000
```
è¾“å…¥ç³»ç»Ÿç”¨æˆ·ï¼ˆå¦‚ `alice`ï¼‰çš„ç”¨æˆ·åä¸å¯†ç ç™»å½•ã€‚

---

## ğŸ§© å…«ã€æ—¥å¿—ä¸è°ƒè¯•

æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š
```bash
sudo systemctl status jupyterhub
sudo tail -f /var/log/jupyterhub.log
```

æŸ¥çœ‹ç«¯å£ç›‘å¬ï¼š
```bash
sudo ss -tulnp | grep jupyterhub
```

---

## ğŸ¯ é™„å½•ï¼šå¸¸è§è·¯å¾„æ€»ç»“

| é¡¹ç›® | è·¯å¾„ |
|------|------|
| Conda ç¯å¢ƒç›®å½• | `/opt/conda/envs/jhub_env/` |
| ç”¨æˆ·ä¸“å± Conda ç¯å¢ƒ | `/opt/conda/envs/<username>/` |
| JupyterHub é…ç½® | `/etc/jupyterhub/jupyterhub_config.py` |
| JupyterHub æ•°æ®åº“ | `/etc/jupyterhub/jupyterhub.sqlite` |
| æ—¥å¿—æ–‡ä»¶ | `/var/log/jupyterhub.log` |
| æœåŠ¡æ–‡ä»¶ | `/etc/systemd/system/jupyterhub.service` |

---
